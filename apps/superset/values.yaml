# Apache Superset Production Values
# This file contains production-ready configuration for Apache Superset deployment
# with proper health checks, resource limits, and autoscaling

# ============================================================================
# IMAGE CONFIGURATION
# ============================================================================
image:
  repository: apache/superset
  tag: "3.1.0"  # Pinned version for stability
  pullPolicy: IfNotPresent

# ============================================================================
# REPLICA AND SCALING CONFIGURATION
# ============================================================================
replicaCount: 1  # Default single replica

autoscaling:
  enabled: true
  minReplicas: 1  # Start with 1 replica
  maxReplicas: 2  # Scale to 2 under load
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 75
  scaleDown:
    stabilizationWindowSeconds: 300
    policies:
      - type: Pods
        value: 1
        periodSeconds: 120
  scaleUp:
    stabilizationWindowSeconds: 60
    policies:
      - type: Pods
        value: 1
        periodSeconds: 60

# ============================================================================
# RESOURCE LIMITS AND REQUESTS
# ============================================================================
resources:
  requests:
    cpu: 500m
    memory: 1Gi
  limits:
    cpu: 2000m
    memory: 4Gi

# ============================================================================
# DEPLOYMENT STRATEGY
# ============================================================================
deploymentStrategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 0

# Extended deadline for Superset's slow initialization
progressDeadlineSeconds: 1200  # 20 minutes

# ============================================================================
# HEALTH CHECKS - CRITICAL FOR DEPLOYMENT SUCCESS
# ============================================================================
livenessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 120  # Superset needs time to initialize
  periodSeconds: 20
  timeoutSeconds: 10
  failureThreshold: 5
  successThreshold: 1

readinessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 60
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 6
  successThreshold: 1

startupProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 30  # 5 minutes total (30 * 10s)
  successThreshold: 1

# ============================================================================
# SERVICE CONFIGURATION
# ============================================================================
service:
  type: ClusterIP
  port: 8088
  annotations: {}

# ============================================================================
# INGRESS CONFIGURATION
# ============================================================================
ingress:
  enabled: true
  ingressClassName: nginx
  hostname: superset.codevertexitsolutions.com
  path: /
  pathType: Prefix
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "300"
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "300"
  tls:
    - hosts:
        - superset.codevertexitsolutions.com
      secretName: superset-codevertexitsolutions-tls

# ============================================================================
# INIT CONTAINERS - WAIT FOR DEPENDENCIES
# ============================================================================
initContainers:
  - name: wait-for-postgres
    image: busybox:1.36
    command:
      - sh
      - -c
      - |
        until nc -z postgresql.infra.svc.cluster.local 5432; do
          echo "Waiting for PostgreSQL..."
          sleep 5
        done
        echo "PostgreSQL is ready"
  - name: wait-for-redis
    image: busybox:1.36
    command:
      - sh
      - -c
      - |
        until nc -z redis-master.infra.svc.cluster.local 6379; do
          echo "Waiting for Redis..."
          sleep 5
        done
        echo "Redis is ready"

# ============================================================================
# BOOTSTRAP CONFIGURATION
# ============================================================================
bootstrapScript: |
  #!/bin/bash
  set -e
  echo "Starting Superset bootstrap..."
  
  # Database migration
  echo "Running database upgrade..."
  superset db upgrade
  
  # Initialize roles and permissions
  echo "Initializing Superset..."
  superset init
  
  # Create default admin if doesn't exist
  if [ -n "${ADMIN_USERNAME}" ] && [ -n "${ADMIN_PASSWORD}" ]; then
    echo "Creating/updating admin user..."
    superset fab create-admin \
      --username "${ADMIN_USERNAME}" \
      --firstname "${ADMIN_FIRSTNAME}" \
      --lastname "${ADMIN_LASTNAME}" \
      --email "${ADMIN_EMAIL}" \
      --password "${ADMIN_PASSWORD}" || true
  fi
  
  echo "Bootstrap completed successfully"

# ============================================================================
# ADMIN USER INITIALIZATION
# ============================================================================
init:
  enabled: true
  adminUser:
    username: admin
    firstname: Admin
    lastname: User
    email: admin@codevertexitsolutions.com
  envFromSecret: superset-secrets
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 2Gi

# ============================================================================
# DATABASE AND CACHE CONFIGURATION
# ============================================================================
# Disable embedded PostgreSQL (using external instance)
postgresql:
  enabled: false

# Disable embedded Redis (using external instance)
redis:
  enabled: false

# External database and cache connections
# DO NOT use supersetNode.connections - it creates a separate superset-env secret
# with default passwords that conflict with our superset-secrets
supersetNode:
  # Load environment variables from secrets (includes DB_*, REDIS_*, SECRET_KEY, etc.)
  envFromSecret: superset-secrets

# ============================================================================
# SUPERSET CONFIGURATION OVERRIDES
# ============================================================================
configOverrides:
  secret_config: |
    import os
    SECRET_KEY = os.environ.get('SUPERSET_SECRET_KEY') or os.environ.get('SECRET_KEY')

  enable_oauth: |
    from flask_appbuilder.security.manager import AUTH_DB
    AUTH_TYPE = AUTH_DB

  custom_config: |
    # Cache configuration
    CACHE_CONFIG = {
        'CACHE_TYPE': 'RedisCache',
        'CACHE_DEFAULT_TIMEOUT': 300,
        'CACHE_KEY_PREFIX': 'superset_',
        'CACHE_REDIS_HOST': 'redis-master.infra.svc.cluster.local',
        'CACHE_REDIS_PORT': 6379,
        'CACHE_REDIS_DB': 0,
    }
    
    # Feature flags
    FEATURE_FLAGS = {
        'ENABLE_TEMPLATE_PROCESSING': True,
        'DASHBOARD_NATIVE_FILTERS': True,
        'DASHBOARD_CROSS_FILTERS': True,
        'DASHBOARD_RBAC': True,
        'EMBEDDED_SUPERSET': True,
    }
    
    # Query settings
    SQL_MAX_ROW = 100000
    SQLLAB_ASYNC_TIME_LIMIT_SEC = 300
    SQLLAB_TIMEOUT = 300
    SUPERSET_WEBSERVER_TIMEOUT = 300
    
    # Security
    WTF_CSRF_ENABLED = True
    WTF_CSRF_TIME_LIMIT = None
    
    # Row level security
    ROW_LEVEL_SECURITY_ENABLED = True

# ============================================================================
# CELERY WORKERS - ASYNC QUERY EXECUTION
# ============================================================================
supersetWorker:
  enabled: true
  replicaCount: 2
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 2Gi
  livenessProbe:
    exec:
      command:
        - sh
        - -c
        - celery -A superset.tasks.celery_app:app inspect ping -d celery@$HOSTNAME
    initialDelaySeconds: 120
    periodSeconds: 60
    timeoutSeconds: 60
    failureThreshold: 3
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 2
    targetCPUUtilizationPercentage: 70

# ============================================================================
# CELERY BEAT - SCHEDULED TASKS
# ============================================================================
supersetCeleryBeat:
  enabled: true
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

# ============================================================================
# HIGH AVAILABILITY CONFIGURATION
# ============================================================================
podDisruptionBudget:
  enabled: true
  minAvailable: 1

# ============================================================================
# SECURITY CONTEXT
# ============================================================================
securityContext:
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
  runAsNonRoot: true

# ============================================================================
# POD AFFINITY - DISTRIBUTE PODS ACROSS NODES
# ============================================================================
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - superset
          topologyKey: kubernetes.io/hostname
