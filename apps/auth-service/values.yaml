# Auth Service Production Configuration
nameOverride: auth-service
fullnameOverride: auth-service
# ============================================================================
# IMAGE CONFIGURATION
# ============================================================================
image:
  repository: docker.io/codevertex/auth-service
  tag: 75f1ed87 # Updated with tenant slug fixes and health endpoint in OpenAPI
  pullPolicy: Always # Force pull to get latest changes
  pullSecrets:
    - name: registry-credentials
# ============================================================================
# REPLICA AND SCALING CONFIGURATION
# ============================================================================
replicaCount: 1
autoscaling:
  enabled: true
  minReplicas: 1
  maxReplicas: 4  # Can scale higher - critical service
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 75
# ============================================================================
# SERVICE CONFIGURATION
# ============================================================================
service:
  type: ClusterIP
  port: 4101
  targetPort: 4101
# ============================================================================
# DEPLOYMENT STRATEGY
# ============================================================================
strategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 0
# ============================================================================
# ENVIRONMENT VARIABLES
# ============================================================================
env:
  - name: AUTH_SERVICE_ENV
    value: production
  - name: AUTH_SERVICE_PORT
    value: "4101"
  # Database connection (auth-service expects AUTH_DB_URL)
  - name: AUTH_DB_URL
    valueFrom:
      secretKeyRef:
        name: auth-service-secrets
        key: postgresUrl
  - name: AUTH_POSTGRES_URL
    valueFrom:
      secretKeyRef:
        name: auth-service-secrets
        key: postgresUrl
  # Auto-run migrations on startup (default: true)
  - name: AUTH_DB_RUN_MIGRATIONS
    value: "true"
  # Redis connection
  - name: AUTH_REDIS_ADDR
    value: redis-master.infra.svc.cluster.local:6379
  - name: AUTH_REDIS_PASSWORD
    valueFrom:
      secretKeyRef:
        name: auth-service-secrets
        key: REDIS_PASSWORD
        optional: true
  # JWT Token Keys (RSA keys for token signing/verification)
  - name: AUTH_TOKEN_PRIVATE_KEY_PATH
    value: /etc/auth-keys/private.pem
  - name: AUTH_TOKEN_PUBLIC_KEY_PATH
    value: /etc/auth-keys/public.pem
  # Seed admin password (for manual seeding if needed)
  - name: SEED_ADMIN_PASSWORD
    value: "ChangeMe123!"
# ============================================================================
# MIGRATIONS AND SEEDING (Automatic on Startup)
# ============================================================================
# Auth-service handles migrations and seeding internally on startup
# - AUTH_DB_RUN_MIGRATIONS=true (default) - runs migrations automatically
# - Seed binary can be called: /usr/local/bin/auth-seed (idempotent)
#
# NOTE: Unlike Django services, Go services typically migrate on startup
# Helm hooks are disabled for this service to avoid complexity
migrations:
  enabled: false # Disabled - auth-service migrates on startup
# Automated seeding via Helm post-install/post-upgrade hook
seed:
  enabled: true # Runs automatically after deployment
  binaryName: auth-seed
  env:
    - name: SEED_ADMIN_PASSWORD
      valueFrom:
        secretKeyRef:
          name: auth-service-secrets
          key: SEED_ADMIN_PASSWORD
          optional: true
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
# ============================================================================
# VOLUME MOUNTS FOR JWT KEYS
# ============================================================================
volumeMounts:
  - name: auth-token-keys
    mountPath: /etc/auth-keys
    readOnly: true
volumes:
  - name: auth-token-keys
    secret:
      secretName: auth-token-keys
      defaultMode: 288 # 0440 in octal = 288 decimal: readable by owner (root) and group (1000 via fsGroup)
# ============================================================================
# RESOURCE LIMITS AND REQUESTS
# ============================================================================
resources:
  requests:
    cpu: 150m  # Balanced for 12-core server - critical service
    memory: 256Mi
  limits:
    cpu: 1000m
    memory: 1Gi
# ============================================================================
# HEALTH CHECKS
# ============================================================================
healthCheck:
  enabled: true
  readiness:
    httpGet:
      path: /healthz
      port: http
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 6
  liveness:
    httpGet:
      path: /healthz
      port: http
    initialDelaySeconds: 30
    periodSeconds: 20
    timeoutSeconds: 5
    failureThreshold: 5
  startup:
    httpGet:
      path: /healthz
      port: http
    initialDelaySeconds: 5
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 15 # 2.5 minutes total (15 * 10s)
# ============================================================================
# INGRESS CONFIGURATION
# ============================================================================
ingress:
  enabled: true
  ingressClassName: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    # Rate limiting for auth endpoints
    nginx.ingress.kubernetes.io/limit-rps: "20"
    nginx.ingress.kubernetes.io/limit-connections: "100"
  hosts:
    - host: sso.codevertexitsolutions.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - hosts:
        - sso.codevertexitsolutions.com
      secretName: sso-codevertexitsolutions-tls
# ============================================================================
# MONITORING AND OBSERVABILITY
# ============================================================================
monitoring:
  enabled: true
  prometheus:
    enabled: true
    port: 9090
    path: /metrics
serviceMonitor:
  enabled: true
  namespace: infra
  interval: 30s
  scrapeTimeout: 10s
  labels:
    release: prometheus
# ============================================================================
# SECURITY CONFIGURATION
# ============================================================================
securityContext:
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
  runAsNonRoot: true
# ============================================================================
# POD DISRUPTION BUDGET
# ============================================================================
podDisruptionBudget:
  enabled: true
  minAvailable: 1
# ============================================================================
# POD AFFINITY - DISTRIBUTE PODS ACROSS NODES
# ============================================================================
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - auth-service
          topologyKey: kubernetes.io/hostname
