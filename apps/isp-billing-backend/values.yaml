# ISP Billing Backend — Production Configuration
# Stack: Python 3.11 + FastAPI + Celery + PostgreSQL + Redis
# ============================================================================
nameOverride: isp-billing-backend
fullnameOverride: isp-billing-backend

# ============================================================================
# IMAGE CONFIGURATION
# ============================================================================
image:
  repository: docker.io/codevertex/isp-billing-backend
  tag: "latest"
  pullPolicy: Always
  pullSecrets:
    - name: registry-credentials

# ============================================================================
# REPLICA AND SCALING CONFIGURATION
# ============================================================================
replicaCount: 1

autoscaling:
  enabled: true
  minReplicas: 1
  maxReplicas: 2
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 75
  scaleDown:
    stabilizationWindowSeconds: 300
    policies:
      - type: Pods
        value: 1
        periodSeconds: 120
    selectPolicy: Min
  scaleUp:
    stabilizationWindowSeconds: 60
    policies:
      - type: Pods
        value: 1
        periodSeconds: 60
    selectPolicy: Max

# ============================================================================
# SERVICE CONFIGURATION
# ============================================================================
service:
  type: ClusterIP
  port: 4000
  targetPort: 8000

# ============================================================================
# DEPLOYMENT STRATEGY
# ============================================================================
strategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 0

minReadySeconds: 30
progressDeadlineSeconds: 600

# ============================================================================
# DATABASE MIGRATIONS (Alembic)
# ============================================================================
migrations:
  enabled: true
  binaryName: alembic
  command: ["alembic", "upgrade", "head"]
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

seed:
  enabled: false

# ============================================================================
# CELERY WORKERS (background billing, provisioning, notification tasks)
# ============================================================================
celeryWorker:
  enabled: true
  replicaCount: 1
  command: ["celery", "-A", "app.core.celery_app", "worker", "--loglevel=info", "--concurrency=2"]
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

celeryBeat:
  enabled: true
  command: ["celery", "-A", "app.core.celery_app", "beat", "--loglevel=info"]
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi

# ============================================================================
# ENVIRONMENT VARIABLES — bulk secret injection
# ============================================================================
envFromSecret: isp-billing-backend-secrets

env:
  # ── Application ──
  - name: ENVIRONMENT
    value: production
  - name: DEBUG
    value: "false"
  - name: HOST
    value: "0.0.0.0"
  - name: PORT
    value: "8000"
  - name: WORKERS
    value: "2"
  - name: APP_NAME
    value: "ISP Billing System"

  # ── Database (async driver for FastAPI) ──
  - name: DATABASE_URL
    valueFrom:
      secretKeyRef:
        name: isp-billing-backend-secrets
        key: DATABASE_URL
  - name: DATABASE_POOL_SIZE
    value: "10"
  - name: DATABASE_MAX_OVERFLOW
    value: "20"

  # ── Redis ──
  - name: REDIS_URL
    valueFrom:
      secretKeyRef:
        name: isp-billing-backend-secrets
        key: REDIS_URL
  - name: REDIS_PASSWORD
    valueFrom:
      secretKeyRef:
        name: isp-billing-backend-secrets
        key: REDIS_PASSWORD
        optional: true

  # ── Celery ──
  - name: CELERY_BROKER_URL
    valueFrom:
      secretKeyRef:
        name: isp-billing-backend-secrets
        key: CELERY_BROKER_URL
  - name: CELERY_RESULT_BACKEND
    valueFrom:
      secretKeyRef:
        name: isp-billing-backend-secrets
        key: CELERY_RESULT_BACKEND

  # ── JWT / Security ──
  - name: SECRET_KEY
    valueFrom:
      secretKeyRef:
        name: isp-billing-backend-secrets
        key: SECRET_KEY
  - name: ALGORITHM
    value: "HS256"
  - name: ACCESS_TOKEN_EXPIRE_MINUTES
    value: "30"
  - name: REFRESH_TOKEN_EXPIRE_DAYS
    value: "7"
  - name: ENCRYPTION_KEY
    valueFrom:
      secretKeyRef:
        name: isp-billing-backend-secrets
        key: ENCRYPTION_KEY
  - name: MASTER_PASSWORD
    valueFrom:
      secretKeyRef:
        name: isp-billing-backend-secrets
        key: MASTER_PASSWORD

  # ── CORS ──
  - name: CORS_ORIGINS
    value: '["https://ispbilling.codevertexitsolutions.com"]'
  - name: CORS_ALLOW_CREDENTIALS
    value: "true"
  - name: FRONTEND_URL
    value: "https://ispbilling.codevertexitsolutions.com"
  - name: API_BASE_URL
    value: "https://ispbillingapi.codevertexitsolutions.com/api/v1"

  # ── M-PESA ──
  - name: MPESA_ENVIRONMENT
    value: "production"
  - name: MPESA_CONSUMER_KEY
    valueFrom:
      secretKeyRef:
        name: isp-billing-backend-secrets
        key: MPESA_CONSUMER_KEY
  - name: MPESA_CONSUMER_SECRET
    valueFrom:
      secretKeyRef:
        name: isp-billing-backend-secrets
        key: MPESA_CONSUMER_SECRET
  - name: MPESA_PASSKEY
    valueFrom:
      secretKeyRef:
        name: isp-billing-backend-secrets
        key: MPESA_PASSKEY
  - name: MPESA_SHORTCODE
    valueFrom:
      secretKeyRef:
        name: isp-billing-backend-secrets
        key: MPESA_SHORTCODE
  - name: MPESA_CALLBACK_URL
    value: "https://ispbillingapi.codevertexitsolutions.com/api/v1/payments/mpesa/callback"

  # ── SMS ──
  - name: SMS_PROVIDER
    valueFrom:
      secretKeyRef:
        name: isp-billing-backend-secrets
        key: SMS_PROVIDER
        optional: true
  - name: AFRICASTALKING_API_KEY
    valueFrom:
      secretKeyRef:
        name: isp-billing-backend-secrets
        key: AFRICASTALKING_API_KEY
        optional: true
  - name: AFRICASTALKING_USERNAME
    valueFrom:
      secretKeyRef:
        name: isp-billing-backend-secrets
        key: AFRICASTALKING_USERNAME
        optional: true

  # ── Email ──
  - name: EMAIL_PROVIDER
    valueFrom:
      secretKeyRef:
        name: isp-billing-backend-secrets
        key: EMAIL_PROVIDER
        optional: true
  - name: SMTP_HOST
    valueFrom:
      secretKeyRef:
        name: isp-billing-backend-secrets
        key: SMTP_HOST
        optional: true
  - name: SMTP_PORT
    valueFrom:
      secretKeyRef:
        name: isp-billing-backend-secrets
        key: SMTP_PORT
        optional: true
  - name: SMTP_USERNAME
    valueFrom:
      secretKeyRef:
        name: isp-billing-backend-secrets
        key: SMTP_USERNAME
        optional: true
  - name: SMTP_PASSWORD
    valueFrom:
      secretKeyRef:
        name: isp-billing-backend-secrets
        key: SMTP_PASSWORD
        optional: true

  # ── MikroTik RouterOS ──
  - name: MIKROTIK_DEFAULT_USERNAME
    valueFrom:
      secretKeyRef:
        name: isp-billing-backend-secrets
        key: MIKROTIK_DEFAULT_USERNAME
        optional: true
  - name: MIKROTIK_DEFAULT_PASSWORD
    valueFrom:
      secretKeyRef:
        name: isp-billing-backend-secrets
        key: MIKROTIK_DEFAULT_PASSWORD
        optional: true
  - name: MIKROTIK_DEFAULT_PORT
    value: "8728"
  - name: MIKROTIK_TIMEOUT
    value: "10"

  # ── Rate Limiting ──
  - name: RATE_LIMIT_ENABLED
    value: "true"
  - name: RATE_LIMIT_REQUESTS
    value: "100"
  - name: RATE_LIMIT_WINDOW
    value: "60"

  # ── Logging ──
  - name: LOG_LEVEL
    value: "INFO"
  - name: LOG_FORMAT
    value: "json"

  # ── Security ──
  - name: BCRYPT_ROUNDS
    value: "12"
  - name: PASSWORD_MIN_LENGTH
    value: "8"
  - name: SESSION_TIMEOUT
    value: "3600"

  # ── Monitoring ──
  - name: SENTRY_DSN
    valueFrom:
      secretKeyRef:
        name: isp-billing-backend-secrets
        key: SENTRY_DSN
        optional: true
  - name: HEALTH_CHECK_INTERVAL
    value: "30"

# ============================================================================
# RESOURCE LIMITS AND REQUESTS
# ============================================================================
resources:
  requests:
    cpu: 200m
    memory: 512Mi
  limits:
    cpu: 1000m
    memory: 1Gi

# ============================================================================
# HEALTH CHECKS (FastAPI serves /health, NOT /healthz)
# ============================================================================
healthCheck:
  enabled: true
  startup:
    httpGet:
      path: /health
      port: http
    initialDelaySeconds: 15
    periodSeconds: 10
    failureThreshold: 30
  readiness:
    httpGet:
      path: /health
      port: http
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  liveness:
    httpGet:
      path: /health
      port: http
    initialDelaySeconds: 30
    periodSeconds: 20
    timeoutSeconds: 5
    failureThreshold: 5

# ============================================================================
# INGRESS CONFIGURATION
# ============================================================================
ingress:
  enabled: true
  ingressClassName: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "20m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "120"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "120"
    # Rate limiting for API endpoints
    nginx.ingress.kubernetes.io/limit-rps: "30"
    nginx.ingress.kubernetes.io/limit-connections: "100"
    # CORS headers (backup — app-level CORS is primary)
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-origin: "https://ispbilling.codevertexitsolutions.com"
  hosts:
    - host: ispbillingapi.codevertexitsolutions.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - hosts:
        - ispbillingapi.codevertexitsolutions.com
      secretName: isp-billing-backend-tls

# ============================================================================
# MONITORING AND OBSERVABILITY
# ============================================================================
monitoring:
  enabled: true
  prometheus:
    enabled: true
    port: 9090
    path: /metrics

serviceMonitor:
  enabled: true
  namespace: infra
  interval: 30s
  scrapeTimeout: 10s
  labels:
    release: prometheus

# ============================================================================
# SECURITY CONTEXT
# ============================================================================
securityContext:
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
  runAsNonRoot: true

# ============================================================================
# POD DISRUPTION BUDGET
# ============================================================================
podDisruptionBudget:
  enabled: true
  minAvailable: 1

