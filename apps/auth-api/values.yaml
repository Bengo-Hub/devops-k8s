# Auth Service Production Configuration
nameOverride: auth-api
fullnameOverride: auth-api
# ============================================================================
# IMAGE CONFIGURATION
# ============================================================================
image:
  repository: docker.io/codevertex/auth-api
  tag: "5dbd2a9b"
  pullPolicy: Always # Force pull to get latest changes
  pullSecrets:
    - name: registry-credentials
# ============================================================================
# REPLICA AND SCALING CONFIGURATION
# ============================================================================
replicaCount: 1
autoscaling:
  enabled: true
  minReplicas: 1
  maxReplicas: 2 # Critical service - reduced to prevent pod limit overflow
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 75
# ============================================================================
# SERVICE CONFIGURATION
# ============================================================================
service:
  type: ClusterIP
  port: 4101
  targetPort: 4101
# ============================================================================
# DEPLOYMENT STRATEGY
# ============================================================================
strategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 0
minReadySeconds: 60
progressDeadlineSeconds: 1200 # 20 minutes for migrations and startup
# ============================================================================
# ENVIRONMENT VARIABLES
# ============================================================================
env:
  - name: AUTH_SERVICE_ENV
    value: production
  - name: AUTH_SERVICE_PORT
    value: "4101"
  # Frontend UI URL for OAuth redirects
  - name: AUTH_UI_URL
    value: "https://accounts.codevertexitsolutions.com"
  # Database connection (auth-api expects AUTH_DB_URL)
  - name: AUTH_DB_URL
    valueFrom:
      secretKeyRef:
        name: auth-api-secrets
        key: postgresUrl
  - name: AUTH_POSTGRES_URL
    valueFrom:
      secretKeyRef:
        name: auth-api-secrets
        key: postgresUrl
  # Disable auto-run migrations on startup (handled by pre-install hook)
  - name: AUTH_DB_RUN_MIGRATIONS
    value: "false"
  # Database connection pool settings (prevent connection exhaustion)
  - name: AUTH_DB_MAX_OPEN_CONNS
    value: "10" # Reduced from default 20 to prevent pool exhaustion
  - name: AUTH_DB_MAX_IDLE_CONNS
    value: "3" # Reduced from default 5
  - name: AUTH_DB_CONN_MAX_LIFETIME
    value: "15m"
  # Redis connection
  - name: AUTH_REDIS_ADDR
    value: redis-master.infra.svc.cluster.local:6379
  - name: AUTH_REDIS_PASSWORD
    valueFrom:
      secretKeyRef:
        name: auth-api-secrets
        key: REDIS_PASSWORD
        optional: true
  # JWT Token Keys (RSA keys for token signing/verification)
  - name: AUTH_TOKEN_PRIVATE_KEY_PATH
    value: /etc/auth-keys/private.pem
  - name: AUTH_TOKEN_PUBLIC_KEY_PATH
    value: /etc/auth-keys/public.pem
  # Token issuer and audience for JWT
  - name: AUTH_TOKEN_ISSUER
    value: "https://sso.codevertexitsolutions.com"
  - name: AUTH_TOKEN_AUDIENCE
    value: "codevertex"
  # OAuth State Secret (for CSRF protection)
  - name: AUTH_SECURITY_OAUTH_STATE_SECRET
    valueFrom:
      secretKeyRef:
        name: auth-api-secrets
        key: OAUTH_STATE_SECRET
        optional: true
  # Google OAuth Provider (optional: true allows deployment without OAuth configured)
  - name: AUTH_PROVIDERS_GOOGLE_ENABLED
    value: "true"
  - name: AUTH_PROVIDERS_GOOGLE_CLIENT_ID
    valueFrom:
      secretKeyRef:
        name: auth-api-secrets
        key: GOOGLE_CLIENT_ID
        optional: true
  - name: AUTH_PROVIDERS_GOOGLE_CLIENT_SECRET
    valueFrom:
      secretKeyRef:
        name: auth-api-secrets
        key: GOOGLE_CLIENT_SECRET
        optional: true
  - name: AUTH_PROVIDERS_GOOGLE_REDIRECT_URL
    value: "https://sso.codevertexitsolutions.com/api/v1/auth/oauth/google/callback"
  # GitHub OAuth Provider (optional: true allows deployment without OAuth configured)
  # Uses GIT_APP_ID/GIT_APP_SECRET to match local dev variable names
  - name: AUTH_PROVIDERS_GITHUB_ENABLED
    value: "true"
  - name: AUTH_PROVIDERS_GITHUB_CLIENT_ID
    valueFrom:
      secretKeyRef:
        name: auth-api-secrets
        key: GIT_APP_ID
        optional: true
  - name: AUTH_PROVIDERS_GITHUB_CLIENT_SECRET
    valueFrom:
      secretKeyRef:
        name: auth-api-secrets
        key: GIT_APP_SECRET
        optional: true
  - name: AUTH_PROVIDERS_GITHUB_REDIRECT_URL
    value: "https://sso.codevertexitsolutions.com/api/v1/auth/oauth/github/callback"
  # Microsoft OAuth Provider (disabled until credentials are configured)
  - name: AUTH_PROVIDERS_MICROSOFT_ENABLED
    value: "false"
  - name: AUTH_PROVIDERS_MICROSOFT_CLIENT_ID
    valueFrom:
      secretKeyRef:
        name: auth-api-secrets
        key: MICROSOFT_CLIENT_ID
        optional: true
  - name: AUTH_PROVIDERS_MICROSOFT_CLIENT_SECRET
    valueFrom:
      secretKeyRef:
        name: auth-api-secrets
        key: MICROSOFT_CLIENT_SECRET
        optional: true
  - name: AUTH_PROVIDERS_MICROSOFT_TENANT_ID
    valueFrom:
      secretKeyRef:
        name: auth-api-secrets
        key: MICROSOFT_TENANT_ID
        optional: true
  - name: AUTH_PROVIDERS_MICROSOFT_REDIRECT_URL
    value: "https://sso.codevertexitsolutions.com/api/v1/auth/oauth/microsoft/callback"
# ============================================================================
# DATABASE SETUP, MIGRATIONS AND SEEDING
# ============================================================================
# For Go services:
#   1. setupDB: Creates the database if missing (runs as Job before migrations)
#   2. migrations: Runs Ent schema.Create() to create tables (pre-install/pre-upgrade hook)
#   3. seed: Populates initial data (post-install/post-upgrade hook)
# All are idempotent and safe to run multiple times

# Setup database if it doesn't exist (must run before migrations)
setupDB:
  enabled: true
  binaryName: auth-setup-db
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      cpu: 200m
      memory: 256Mi
# Create database schema via Ent migrations
# Uses LoadDatabaseOnly() to avoid OAuth validation - only needs AUTH_DB_URL
migrations:
  enabled: true
  binaryName: auth-migrate
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
# Seed initial data (tenants, demo user, admin user)
# Uses LoadForSeed() to avoid OAuth validation - only needs AUTH_DB_URL and security config
seed:
  enabled: true
  binaryName: auth-seed
  env:
    - name: SEED_ADMIN_PASSWORD
      valueFrom:
        secretKeyRef:
          name: auth-api-secrets
          key: SEED_ADMIN_PASSWORD
          optional: true
    - name: SEED_ADMIN_EMAIL
      valueFrom:
        secretKeyRef:
          name: auth-api-secrets
          key: SEED_ADMIN_EMAIL
          optional: true
    - name: DEFAULT_TENANT_SLUG
      valueFrom:
        secretKeyRef:
          name: auth-api-secrets
          key: DEFAULT_TENANT_SLUG
          optional: true
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
# ============================================================================
# VOLUME MOUNTS FOR JWT KEYS
# ============================================================================
volumeMounts:
  - name: auth-token-keys
    mountPath: /etc/auth-keys
    readOnly: true
volumes:
  - name: auth-token-keys
    secret:
      secretName: auth-token-keys
      defaultMode: 288 # 0440 in octal = 288 decimal: readable by owner (root) and group (1000 via fsGroup)
# ============================================================================
# RESOURCE LIMITS AND REQUESTS
# ============================================================================
resources:
  requests:
    cpu: 150m # Balanced for 12-core server - critical service
    memory: 256Mi
  limits:
    cpu: 1000m
    memory: 1Gi
# ============================================================================
# HEALTH CHECKS
# ============================================================================
healthCheck:
  enabled: true
  startup:
    httpGet:
      path: /healthz
      port: http
    initialDelaySeconds: 30
    periodSeconds: 10
    failureThreshold: 60 # 10 minutes total for startup
  readiness:
    httpGet:
      path: /healthz
      port: http
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 5
  liveness:
    httpGet:
      path: /healthz
      port: http
    initialDelaySeconds: 120
    periodSeconds: 30
    timeoutSeconds: 5
    failureThreshold: 5
# ============================================================================
# INGRESS CONFIGURATION
# ============================================================================
ingress:
  enabled: true
  ingressClassName: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-body-size: "10m"
    nginx.ingress.kubernetes.io/proxy-read-timeout: "60"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "60"
    # Rate limiting for auth endpoints
    nginx.ingress.kubernetes.io/limit-rps: "20"
    nginx.ingress.kubernetes.io/limit-connections: "100"
  hosts:
    - host: sso.codevertexitsolutions.com
      paths:
        - path: /
          pathType: Prefix
  tls:
    - hosts:
        - sso.codevertexitsolutions.com
      secretName: sso-codevertexitsolutions-tls
# ============================================================================
# MONITORING AND OBSERVABILITY
# ============================================================================
monitoring:
  enabled: true
  prometheus:
    enabled: true
    port: 9090
    path: /metrics
serviceMonitor:
  enabled: true
  namespace: infra
  interval: 30s
  scrapeTimeout: 10s
  labels:
    release: prometheus
# ============================================================================
# SECURITY CONFIGURATION
# ============================================================================
securityContext:
  runAsUser: 1000
  runAsGroup: 1000
  fsGroup: 1000
  runAsNonRoot: true
# ============================================================================
# POD DISRUPTION BUDGET
# ============================================================================
podDisruptionBudget:
  enabled: true
  minAvailable: 1
# ============================================================================
# POD AFFINITY - DISTRIBUTE PODS ACROSS NODES
# ============================================================================
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
      - weight: 100
        podAffinityTerm:
          labelSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - auth-api
          topologyKey: kubernetes.io/hostname
