apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: postgresql
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://charts.bitnami.com/bitnami
    chart: postgresql
    targetRevision: 16.7.27
    helm:
      values: |
        ## Global settings
        global:
          postgresql:
            auth:
              postgresPassword: "" # Leave empty, will be auto-generated (or set via POSTGRES_PASSWORD env)
              # Common admin user for accessing all service databases
              # This user can create databases and manage users for all services
              username: "admin_user"
              password: ""         # Leave empty, will be auto-generated (or set via POSTGRES_ADMIN_PASSWORD env)
              database: "postgres" # Use postgres as default, services create their own databases
          # FIPS compliance settings (required for newer chart versions)
          # Must be explicitly set to false to avoid chart validation errors
          defaultFips: false
          # Allow custom images (required for codevertex/postgresql-pgvector)
          security:
            allowInsecureImages: true
        
        # FIPS OpenSSL configuration
        # Must be explicitly set to avoid chart validation errors
        fips:
          openssl: false

        ## Volume permissions configuration
        ## Disable to avoid pulling Bitnami helper images
        volumePermissions:
          enabled: false
        
        ## Disable shmVolume (uses Bitnami image for init)
        shmVolume:
          enabled: false
        
        ## Primary PostgreSQL configuration
        primary:
          ## Create admin user with superuser privileges for managing all service databases
          ## This allows services to create their own databases using this admin user
          ## Enable pgvector extension for all databases
          initdb:
            scripts:
              create-admin-user.sql: |
                -- Ensure admin_user has superuser privileges for managing all service databases
                -- The user is created by the chart's auth.username setting, but we ensure proper privileges
                DO $$
                BEGIN
                  IF EXISTS (SELECT FROM pg_user WHERE usename = 'admin_user') THEN
                    ALTER USER admin_user WITH SUPERUSER CREATEDB;
                  END IF;
                END
                $$;
              enable-pgvector.sql: |
                -- Enable pgvector extension in postgres database
                -- Services can enable it in their own databases during initialization
                CREATE EXTENSION IF NOT EXISTS vector;
                
                -- Grant usage on vector extension to admin_user
                GRANT USAGE ON SCHEMA public TO admin_user;
          ## Custom PostgreSQL image with pgvector extension
          ## Uses custom image built via GitHub Actions workflow
          image:
            registry: docker.io
            repository: codevertex/postgresql-pgvector
            tag: latest
            pullPolicy: Always
          ## Pod security context - run as postgres user (ID 1001 in Bitnami images)
          podSecurityContext:
            fsGroup: 1001
            runAsUser: 1001
            runAsNonRoot: true
          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "2Gi"
              cpu: "1000m"
          priorityClassName: db-critical
          
          persistence:
            enabled: true
            size: 20Gi  # Adjust based on data size
            storageClass: ""  # Use default storage class
          
          ## PostgreSQL tuning
          extendedConfiguration: |
            max_connections = 200
            shared_buffers = 512MB
            effective_cache_size = 1536MB
            work_mem = 2621kB
            maintenance_work_mem = 128MB
            checkpoint_completion_target = 0.9
            wal_buffers = 16MB
            default_statistics_target = 100
            random_page_cost = 1.1
            effective_io_concurrency = 200
            min_wal_size = 1GB
            max_wal_size = 4GB
          
          ## Health checks
          livenessProbe:
            enabled: true
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 6
          
          readinessProbe:
            enabled: true
            initialDelaySeconds: 5
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 6

        ## Read replicas (optional, for scaling reads)
        readReplicas:
          replicaCount: 0  # Set to 1+ for read replicas
          ## Use custom PostgreSQL image with pgvector extension (same as primary)
          image:
            registry: docker.io
            repository: codevertex/postgresql-pgvector
            tag: latest
            pullPolicy: Always
          ## Pod security context - run as postgres user
          podSecurityContext:
            fsGroup: 1001
            runAsUser: 1001
            runAsNonRoot: true
          resources:
            requests:
              memory: "512Mi"
              cpu: "250m"
            limits:
              memory: "2Gi"
              cpu: "1000m"
          priorityClassName: db-critical
          
          persistence:
            enabled: true
            size: 20Gi

        ## Metrics for Prometheus
        metrics:
          enabled: true
          ## Use official Prometheus Community postgres-exporter
          ## Avoids Bitnami registry dependency
          image:
            registry: quay.io
            repository: prometheuscommunity/postgres-exporter
            tag: v0.15.0
            pullPolicy: IfNotPresent
          serviceMonitor:
            enabled: true
            namespace: infra
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "200m"

        ## Backup configuration
        backup:
          enabled: false  # Set to true if using built-in backup
          cronjob:
            schedule: "0 2 * * *"  # Daily at 2 AM
            storage:
              size: 10Gi

        ## Network policy (restrict access)
        networkPolicy:
          enabled: false  # Set to true for production
          allowExternal: false
          explicitNamespacesSelector: {}
  destination:
    server: https://kubernetes.default.svc
    namespace: infra
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true


