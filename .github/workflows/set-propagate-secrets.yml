name: Set Propagate Secrets

on:
  workflow_dispatch: {}

permissions:
  contents: read
  secrets: write

jobs:
  set-propagate-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Check inputs
        run: |
          if [ -z "${{ secrets.SECRETS_PAYLOAD }}" ]; then
            echo "ERROR: SECRETS_PAYLOAD secret is not set."
            echo "Usage: Add SECRETS_PAYLOAD (base64 of the exported secrets file) to devops-k8s repository secrets, then run this workflow."
            exit 1
          fi

      - name: Decode payload to file
        run: |
          echo "Decoding SECRETS_PAYLOAD to /tmp/exported-secrets.txt"
          echo "${{ secrets.SECRETS_PAYLOAD }}" | base64 -d > /tmp/exported-secrets.txt
          chmod 600 /tmp/exported-secrets.txt

      - name: Ensure GH CLI available
        run: |
          if ! command -v gh >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y gh >/dev/null
          fi

      - name: Authenticate GH CLI with GH_PAT
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          if [ -z "${GH_PAT:-}" ]; then
            echo "ERROR: GH_PAT secret is required in devops-k8s to set propagate secrets"
            exit 1
          fi
          echo "${GH_PAT}" | gh auth login --with-token

      - name: Set PROPAGATE_SECRETS secret
        run: |
          ENCODED=$(base64 -w0 /tmp/exported-secrets.txt 2>/dev/null || base64 /tmp/exported-secrets.txt | tr -d '\n')
          echo "Setting PROPAGATE_SECRETS in devops-k8s"
          echo "$ENCODED" | gh secret set PROPAGATE_SECRETS --repo "${{ github.repository }}" --body -
          echo "PROPAGATE_SECRETS set"
