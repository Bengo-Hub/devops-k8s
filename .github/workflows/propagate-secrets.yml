name: Propagate secrets (remote)

on:
  repository_dispatch:
    types:
      - propagate-secrets
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Target repository (e.g., Bengo-Hub/isp-billing-backend)'
        required: true
        type: string
      secrets:
        description: 'Comma-separated secret names to propagate'
        required: true
        type: string

permissions:
  contents: read
  actions: write

jobs:
  propagate:
    runs-on: ubuntu-latest
    steps:
      - name: Debug - Show dispatch payload
        run: |
          echo "=== Repository Dispatch Received ==="
          echo "Event type: ${{ github.event.action }}"
          echo "Target repo: ${{ github.event.client_payload.target_repo }}"
          echo "Secrets requested: ${{ toJson(github.event.client_payload.secrets) }}"
          echo "GitHub event name: ${{ github.event_name }}"
          echo "Repository: ${{ github.repository }}"
          
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure GH CLI available
        run: |
          echo "=== Checking GH CLI ==="
          if ! command -v gh >/dev/null 2>&1; then
            echo "Installing gh"
            sudo apt-get update && sudo apt-get install -y gh >/dev/null
          fi
          gh --version
          echo "✓ GH CLI available"

      - name: Authenticate GH CLI with GH_PAT
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          echo "=== Authenticating GH CLI ==="
          if [ -z "${GH_PAT:-}" ]; then
            echo "ERROR: GH_PAT secret is not set in devops-k8s repository"
            exit 1
          fi
          echo "GH_PAT length: ${#GH_PAT}"
          echo "${GH_PAT}" | gh auth login --with-token
          gh auth status
          echo "✓ GH CLI authenticated"

      - name: Prepare secrets file
        env:
          PROPAGATE_SECRETS: ${{ secrets.PROPAGATE_SECRETS }}
        run: |
          echo "=== Preparing Secrets File ==="
          if [ -z "${PROPAGATE_SECRETS:-}" ]; then
            echo "ERROR: PROPAGATE_SECRETS is not set in devops-k8s. Cannot propagate secrets."
            echo "Action: Run the 'Set Propagate Secrets' workflow in devops-k8s to initialize PROPAGATE_SECRETS."
            echo "See: .github/workflows/set-propagate-secrets.yml"
            exit 1
          fi
          echo "PROPAGATE_SECRETS length: ${#PROPAGATE_SECRETS}"
          echo "Decoding PROPAGATE_SECRETS to /tmp/propagate-secrets.txt"
          echo "${PROPAGATE_SECRETS}" | base64 -d > /tmp/propagate-secrets.txt
          chmod 600 /tmp/propagate-secrets.txt
          echo "Decoded file size: $(wc -c < /tmp/propagate-secrets.txt) bytes"
          echo "Secrets count: $(grep -c '^secret:' /tmp/propagate-secrets.txt || echo 0)"
          echo "✓ Secrets file prepared"

      - name: Run propagate script
        run: |
          echo "=== Running Propagate Script ==="
          TARGET_REPO="${{ github.event.client_payload.target_repo }}"
          echo "Target repository: $TARGET_REPO"
          
          # Support secrets passed as array or comma/space-separated string
          if [ -z "${{ toJson(github.event.client_payload.secrets) }}" ] || [ "${{ github.event.client_payload.secrets }}" = "null" ]; then
            echo "ERROR: No secrets provided in client_payload"
            exit 1
          fi
          
          # Build arguments
          SECRETS_ARGS=""
          if [ "$(echo '${{ github.event.client_payload.secrets }}' | jq -e . >/dev/null 2>&1; echo $?)" = "0" ]; then
            # it's JSON array
            echo "Parsing secrets from JSON array"
            for s in $(echo '${{ github.event.client_payload.secrets }}' | jq -r '.[]'); do
              SECRETS_ARGS+=" $s"
            done
          else
            SECRETS_ARGS="${{ github.event.client_payload.secrets }}"
          fi
          
          echo "Secrets to propagate:$SECRETS_ARGS"
          echo "PROPAGATE_SECRETS_FILE: /tmp/propagate-secrets.txt"
          echo ""
          echo "Invoking propagate-to-repo.sh..."
          
          if env PROPAGATE_SECRETS_FILE=/tmp/propagate-secrets.txt bash scripts/tools/propagate-to-repo.sh "$TARGET_REPO" $SECRETS_ARGS; then
            echo ""
            echo "✓ Secrets propagated successfully to $TARGET_REPO"
          else
            echo ""
            echo "✗ Failed to propagate secrets to $TARGET_REPO"
            exit 1
          fi
