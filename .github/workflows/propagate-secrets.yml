name: Propagate Base64 Secrets to Repos

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type YES to confirm running this workflow (destructive action)'
        required: true
        default: 'NO'

permissions:
  contents: read

jobs:
  propagate:
    name: Propagate secrets
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'YES'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pynacl requests

      - name: Decode secrets and propagate
        env:
          ORG: 'Bengo-Hub'
          PROPAGATE_PAT: ${{ secrets.PROPAGATE_PAT }}
          PROPAGATE_SECRETS: ${{ secrets.PROPAGATE_SECRETS }}
        run: |
          set -euo pipefail
          python - <<'PY'
import os, base64, requests, sys
from nacl.public import PublicKey, SealedBox

ORG = os.environ.get('ORG')
PAT = os.environ.get('PROPAGATE_PAT')
secrets_b64 = os.environ.get('PROPAGATE_SECRETS')

if not (ORG and PAT and secrets_b64):
    print('Missing required environment variables (ORG, PROPAGATE_PAT, PROPAGATE_SECRETS)')
    sys.exit(1)

headers = {
    'Accept': 'application/vnd.github+json',
    'Authorization': f'token {PAT}'
}

# Decode and parse secrets file (format: blocks separated by '---' with 'secret: NAME' and 'value: VALUE')
plaintext = base64.b64decode(secrets_b64).decode('utf-8')
blocks = [b.strip() for b in plaintext.split('\n---\n') if b.strip()]
secrets = {}
for b in blocks:
    lines = b.splitlines()
    name = None
    value_lines = []
    i = 0
    while i < len(lines):
        line = lines[i]
        if line.startswith('secret:'):
            name = line.split(':',1)[1].strip()
        elif line.startswith('value:'):
            # value may be multi-line until next 'secret:' or block end
            v = line.split(':',1)[1].lstrip()
            value_lines.append(v)
            j = i+1
            while j < len(lines) and not lines[j].startswith('secret:'):
                value_lines.append(lines[j])
                j += 1
            break
        i += 1
    if name:
        value = '\n'.join(value_lines).strip()
        # Base64-encode the value as requested
        b64_val = base64.b64encode(value.encode('utf-8')).decode('utf-8')
        secrets[name] = b64_val

if not secrets:
    print('No secrets parsed from PROPAGATE_SECRETS')
    sys.exit(1)

print(f'Parsed {len(secrets)} secrets. Preparing to propagate to org: {ORG}')

# Paginate repos
repos = []
page = 1
while True:
    r = requests.get(f'https://api.github.com/orgs/{ORG}/repos', params={'per_page':100,'page':page}, headers=headers)
    r.raise_for_status()
    data = r.json()
    if not data:
        break
    for repo in data:
        repos.append(repo['full_name'])
    page += 1

print(f'Found {len(repos)} repos')

# For each repo and secret, encrypt and set via REST API
for repo in repos:
    owner_repo = repo
    print(f'Processing repo: {owner_repo}')
    # fetch public key
    r = requests.get(f'https://api.github.com/repos/{owner_repo}/actions/secrets/public-key', headers=headers)
    if r.status_code != 200:
        print(f'  Skipping {owner_repo}: cannot fetch public key ({r.status_code})')
        continue
    key_obj = r.json()
    key = key_obj['key']
    key_id = key_obj['key_id']
    pubkey = base64.b64decode(key)
    pk = PublicKey(pubkey)
    sealed_box = SealedBox(pk)

    for name, b64_val in secrets.items():
        try:
            encrypted = sealed_box.encrypt(b64_val.encode('utf-8'))
            enc_b64 = base64.b64encode(encrypted).decode('utf-8')
            payload = {'encrypted_value': enc_b64, 'key_id': key_id}
            put = requests.put(f'https://api.github.com/repos/{owner_repo}/actions/secrets/{name}', headers=headers, json=payload)
            if put.status_code in (201,204):
                print(f'  Set secret {name} in {owner_repo}')
            else:
                print(f'  Failed to set secret {name} in {owner_repo}: {put.status_code} {put.text}')
        except Exception as e:
            print(f'  Error setting {name} in {owner_repo}: {e}')

print('Propagation complete')
PY

      - name: Cleanup warning
        run: echo "Propagation finished. Verify secrets and remove PROPAGATE_SECRETS/PROPAGATE_PAT from repo secrets when done."