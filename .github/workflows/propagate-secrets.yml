name: Propagate secrets (remote)

on:
  repository_dispatch:
    types: [propagate-secrets]

permissions:
  contents: read
  workflows: write

jobs:
  propagate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure GH CLI available
        run: |
          if ! command -v gh >/dev/null 2>&1; then
            echo "Installing gh"
            sudo apt-get update && sudo apt-get install -y gh >/dev/null
          fi

      - name: Authenticate GH CLI with GH_PAT
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          if [ -z "${GH_PAT:-}" ]; then
            echo "ERROR: GH_PAT secret is not set in devops-k8s repository"
            exit 1
          fi
          echo "${GH_PAT}" | gh auth login --with-token

      - name: Prepare secrets file
        env:
          PROPAGATE_SECRETS: ${{ secrets.PROPAGATE_SECRETS }}
        run: |
          if [ -z "${PROPAGATE_SECRETS:-}" ]; then
            echo "ERROR: PROPAGATE_SECRETS is not set in devops-k8s. Cannot propagate secrets."
            echo "Action: Run the 'Set Propagate Secrets' workflow in devops-k8s to initialize PROPAGATE_SECRETS."
            echo "See: .github/workflows/set-propagate-secrets.yml"
            exit 1
          fi
          echo "Decoding PROPAGATE_SECRETS to /tmp/propagate-secrets.txt"
          echo "${PROPAGATE_SECRETS}" | base64 -d > /tmp/propagate-secrets.txt
          chmod 600 /tmp/propagate-secrets.txt

      - name: Run propagate script
        run: |
          TARGET_REPO="${{ github.event.client_payload.target_repo }}"
          # Support secrets passed as array or comma/space-separated string
          if [ -z "${{ toJson(github.event.client_payload.secrets) }}" ] || [ "${{ github.event.client_payload.secrets }}" = "null" ]; then
            echo "No secrets provided in client_payload"
            exit 1
          fi
          # Build arguments
          SECRETS_ARGS=""
          if [ "$(echo '${{ github.event.client_payload.secrets }}' | jq -e . >/dev/null 2>&1; echo $?)" = "0" ]; then
            # it's JSON array
            for s in $(echo '${{ github.event.client_payload.secrets }}' | jq -r '.[]'); do
              SECRETS_ARGS+=" $s"
            done
          else
            SECRETS_ARGS="${{ github.event.client_payload.secrets }}"
          fi
          echo "Invoking propagate-to-repo.sh for $TARGET_REPO with:$SECRETS_ARGS"
          env PROPAGATE_SECRETS_FILE=/tmp/propagate-secrets.txt bash scripts/tools/propagate-to-repo.sh "$TARGET_REPO" $SECRETS_ARGS
