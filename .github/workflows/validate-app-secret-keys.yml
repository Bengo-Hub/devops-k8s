name: Validate app secret keys

on:
  push:
    paths:
      - 'apps/**/values.yaml'

permissions:
  contents: read

jobs:
  report-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: List referenced secret keys
        run: |
          set -euo pipefail
          echo "Scanning app values for secret keys..."
          for f in apps/*/values.yaml; do
            if [ -f "$f" ]; then
              app=$(basename "$(dirname "$f")")
              echo "\n==> $app"
              grep -E "secretKeyRef:|valueFrom:" -n "$f" || true
              echo "Referenced secret key names (secretKeyRef.name):"
              awk '/secretKeyRef:/{getline; print;}' "$f" | sed -n 'N;s/\n/ /;s/^ *name: //p' || true
            fi
          done
