name: Helm template validation

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Helm
        run: |
          set -euo pipefail
          HELM_VERSION=v3.13.4
          curl -fsSL "https://get.helm.sh/helm-${HELM_VERSION}-linux-amd64.tar.gz" -o helm.tgz
          tar -zxvf helm.tgz
          sudo mv linux-amd64/helm /usr/local/bin/helm
          helm version

      - name: Validate Helm templates for apps
        run: |
          set -euo pipefail
          CHART_DIR=charts/app
          echo "Searching for app values files in apps/*/values.yaml"
          for VALUES in apps/*/values.yaml; do
            if [ -f "$VALUES" ]; then
              APP=$(basename "$(dirname "$VALUES")")
              echo "\n==> Rendering $APP using $VALUES"
              helm template "$APP" "$CHART_DIR" --values "$VALUES" --namespace "$APP" --include-crds >/dev/null
              echo "  âœ“ $APP rendered successfully"
            fi
          done
