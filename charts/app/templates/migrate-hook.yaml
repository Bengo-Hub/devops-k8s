{{- if and .Values.migrations .Values.migrations.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "app.fullname" . }}-migrate-{{ .Values.image.tag | trunc 8 }}
  namespace: {{ .Release.Namespace }}
  labels:
    app: {{ include "app.fullname" . }}
    component: migration
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  ttlSecondsAfterFinished: 600
  backoffLimit: 2
  template:
    metadata:
      labels:
        app: {{ include "app.fullname" . }}
        component: migration
    spec:
      restartPolicy: Never
      {{- if .Values.securityContext }}
      securityContext:
        {{- if .Values.securityContext.fsGroup }}
        fsGroup: {{ .Values.securityContext.fsGroup }}
        {{- end }}
      {{- end }}
      {{- if .Values.image.pullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.image.pullSecrets | nindent 8 }}
      {{- end }}
      {{- if .Values.volumes }}
      volumes:
        {{- toYaml .Values.volumes | nindent 8 }}
      {{- end }}
      containers:
      - name: migrate
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy | default "IfNotPresent" }}
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
        {{- if .Values.volumeMounts }}
        volumeMounts:
          {{- toYaml .Values.volumeMounts | nindent 10 }}
        {{- end }}
        {{- if .Values.envFromSecret }}
        envFrom:
        - secretRef:
            name: {{ .Values.envFromSecret }}
        {{- end }}
        {{- if .Values.env }}
        env:
          {{- range $i, $e := .Values.env }}
          - name: {{$e.name}}
            {{- if $e.value }}
            value: {{ $e.value | quote }}
            {{- else if and $e.valueFrom $e.valueFrom.secretKeyRef }}
            valueFrom:
              secretKeyRef:
                name: {{$e.valueFrom.secretKeyRef.name}}
                key: {{$e.valueFrom.secretKeyRef.key}}
                optional: true
            {{- else }}
            {{- toYaml $e | nindent 12 }}
            {{- end }}
          {{- end }}
        {{- end }}
        resources:
          requests:
            memory: {{ .Values.migrations.resources.requests.memory | default "512Mi" }}
            cpu: {{ .Values.migrations.resources.requests.cpu | default "250m" }}
          limits:
            memory: {{ .Values.migrations.resources.limits.memory | default "2Gi" }}
            cpu: {{ .Values.migrations.resources.limits.cpu | default "1000m" }}
        command:
        - sh
        - -c
        - |
          set -e

          echo "=========================================="
          echo "Database Migrations - Helm Hook"
          echo "=========================================="
          echo "Namespace: {{ .Release.Namespace }}"
          echo "Release: {{ .Release.Name }}"
          echo "Image: {{ .Values.image.repository }}:{{ .Values.image.tag }}"
          echo "Pod: $HOSTNAME"
          echo ""

          # Ensure critical secrets are present before attempting migrations
          # Wait for critical keys for up to ~2 minutes before giving up
          CRITICAL_KEYS="DATABASE_URL SECRET_KEY"
          for key in $CRITICAL_KEYS; do
            COUNT=0
            eval "val=\"\${${key}:-}\""
            while [ -z "$val" ] && [ $COUNT -lt 60 ]; do
              echo "Waiting for secret key $key to be available in environment... (attempt $((COUNT+1))/60)"
              sleep 2
              COUNT=$((COUNT+1))
              eval "val=\"\${${key}:-}\""
            done
            if [ -z "$val" ]; then
              echo "WARNING: $key still not set after timeout - migration may fail or skip depending on app type"
            else
              echo "$key detected"
            fi
          done

          {{- if .Values.migrations.command }}
          # Explicit migration command configured in values.yaml
          echo "Running configured migration command: {{ join " " .Values.migrations.command }}"
          {{ join " " .Values.migrations.command }}
          echo "Migration command completed successfully"
          {{- else }}
          # Detect framework and run appropriate migrations
          if [ -f "/app/manage.py" ]; then
            # Django application
            echo "Detected Django application"

            # Wait for database using Django's built-in check
            echo "Waiting for database connection..."
            MAX_RETRIES=60
            RETRY_COUNT=0

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if python manage.py check --database default > /dev/null 2>&1; then
                echo "Database connection successful"
                break
              fi

              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $((RETRY_COUNT % 10)) -eq 0 ]; then
                echo "  Still waiting... (attempt $RETRY_COUNT/$MAX_RETRIES)"
              fi
              sleep 2
            done

            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "Failed to connect to database after $MAX_RETRIES attempts"
              exit 1
            fi

            echo ""
            echo "Running Django migrations..."
            python manage.py migrate --fake-initial --noinput
            echo "Django migrations completed"

          elif [ -x "/usr/local/bin/{{ .Values.migrations.binaryName | default (printf "%s-migrate" (include "app.name" .)) }}" ] || [ -x "/app/migrate" ]; then
            # Go application with Ent
            echo "Detected Go application (Ent ORM)"

            if [ -x "/usr/local/bin/{{ .Values.migrations.binaryName | default (printf "%s-migrate" (include "app.name" .)) }}" ]; then
              echo "Running migrate binary: /usr/local/bin/{{ .Values.migrations.binaryName | default (printf "%s-migrate" (include "app.name" .)) }}"
              /usr/local/bin/{{ .Values.migrations.binaryName | default (printf "%s-migrate" (include "app.name" .)) }}
            elif [ -x "/app/migrate" ]; then
              echo "Running migrate binary: /app/migrate"
              /app/migrate
            else
              echo "Migrate binary not found"
              exit 1
            fi

            echo "Ent migrations completed"

          elif [ -f "/app/artisan" ]; then
            # Laravel application
            echo "Detected Laravel application"

            echo "Running Laravel migrations..."
            php artisan migrate --force
            echo "Laravel migrations completed"

          elif command -v alembic >/dev/null 2>&1 || [ -f "/app/alembic.ini" ]; then
            # Python application with Alembic (FastAPI, Flask, etc.)
            echo "Detected Python application (Alembic)"

            echo "Running Alembic migrations..."
            alembic upgrade head
            echo "Alembic migrations completed"

          else
            echo "No recognized framework detected"
            echo "Searched for: Django (manage.py), Go/Ent (migrate binary), Laravel (artisan), Python/Alembic (alembic.ini)"
            echo "Tip: Set migrations.command in values.yaml to specify a custom migration command"
            exit 1
          fi
          {{- end }}

          echo ""
          echo "=========================================="
          echo "Migration Job Complete"
          echo "=========================================="
{{- end }}

