{{- if and .Values.migrations .Values.migrations.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "app.fullname" . }}-migrate-{{ .Values.image.tag | trunc 8 }}
  namespace: {{ .Release.Namespace }}
  labels:
    app: {{ include "app.fullname" . }}
    component: migration
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  ttlSecondsAfterFinished: 600
  backoffLimit: 2
  template:
    metadata:
      labels:
        app: {{ include "app.fullname" . }}
        component: migration
    spec:
      restartPolicy: Never
      {{- if .Values.image.pullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.image.pullSecrets | nindent 8 }}
      {{- end }}
      containers:
      - name: migrate
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy | default "IfNotPresent" }}
        # Security context - run as app user (no apt-get needed, Django does the checking)
        securityContext:
          runAsNonRoot: true
          runAsUser: 1000
          runAsGroup: 1000
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
        # Load environment variables from the same secret as the main app
        {{- if .Values.envFromSecret }}
        envFrom:
        - secretRef:
            name: {{ .Values.envFromSecret }}
        {{- end }}
        resources:
          requests:
            memory: {{ .Values.migrations.resources.requests.memory | default "512Mi" }}
            cpu: {{ .Values.migrations.resources.requests.cpu | default "250m" }}
          limits:
            memory: {{ .Values.migrations.resources.limits.memory | default "2Gi" }}
            cpu: {{ .Values.migrations.resources.limits.cpu | default "1000m" }}
        command:
        - bash
        - -c
        - |
          set -e
          
          echo "=========================================="
          echo "ðŸ”„ Django Migrations - Helm Hook"
          echo "=========================================="
          echo "Namespace: {{ .Release.Namespace }}"
          echo "Release: {{ .Release.Name }}"
          echo "Image: {{ .Values.image.repository }}:{{ .Values.image.tag }}"
          echo "Pod: $HOSTNAME"
          
          # Debug: Print connection info (secure)
          echo ""
          echo "ðŸ“Š Database Configuration:"
          echo "  Host: ${DB_HOST:-not set}"
          echo "  Port: ${DB_PORT:-not set}"
          echo "  Database: ${DB_NAME:-not set}"
          echo "  User: ${DB_USER:-not set}"
          echo "  Password: ${DB_PASSWORD:+***configured***}"
          echo "  DATABASE_URL: ${DATABASE_URL:+***configured***}"
          echo ""
          
          # Wait for database using Django's built-in check (no apt-get needed)
          echo "â³ Waiting for database connection..."
          MAX_RETRIES=60
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            # Use Django's database check - most reliable method
            if python manage.py check --database default > /dev/null 2>&1; then
              echo "âœ… Database connection successful (attempt $RETRY_COUNT)"
              break
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            
            # Show detailed error every 10 attempts
            if [ $((RETRY_COUNT % 10)) -eq 0 ]; then
              echo "  â³ Still waiting for database... (attempt $RETRY_COUNT/$MAX_RETRIES)"
              python manage.py check --database default 2>&1 | head -5 || true
            fi
            
            sleep 2
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo ""
            echo "âŒ Failed to connect to database after $MAX_RETRIES attempts"
            echo ""
            echo "ðŸ” Troubleshooting Information:"
            echo "1. Verify PostgreSQL is running:"
            echo "   kubectl get pods -n infra -l app=postgresql"
            echo ""
            echo "2. Check if secret exists and has correct keys:"
            echo "   kubectl get secret {{ .Values.envFromSecret }} -n {{ .Release.Namespace }}"
            echo "   kubectl describe secret {{ .Values.envFromSecret }} -n {{ .Release.Namespace }}"
            echo ""
            echo "3. Verify database service is accessible:"
            echo "   kubectl get svc -n infra | grep postgres"
            echo ""
            echo "4. Check network policies:"
            echo "   kubectl get networkpolicies -n {{ .Release.Namespace }}"
            echo ""
            echo "Last connection attempt output:"
            python manage.py check --database default 2>&1 || true
            exit 1
          fi
          
          echo ""
          echo "ðŸ”„ Running Django migrations..."
          echo "Strategy: Using --fake-initial for safety"
          echo ""
          
          # Run migrations with --fake-initial (idempotent and safe for existing DBs)
          if python manage.py migrate --fake-initial --noinput 2>&1; then
            echo "âœ… Migrations completed successfully"
          else
            echo "âš ï¸ --fake-initial failed, trying regular migrate..."
            if python manage.py migrate --noinput 2>&1; then
              echo "âœ… Regular migrations completed"
            else
              echo "âŒ Both migration strategies failed"
              echo ""
              echo "Migration errors above - please review"
              exit 1
            fi
          fi
          
          echo ""
          echo "ðŸ“Š Migration Status:"
          python manage.py showmigrations --list 2>&1 | grep -E "^\[X\]|^\[ \]|^[a-z]" | head -30 || true
          
          echo ""
          echo "=========================================="
          echo "âœ… Migration Job Complete"
          echo "=========================================="
        {{- if .Values.envFromSecret }}
        envFrom:
        - secretRef:
            name: {{ .Values.envFromSecret }}
        {{- end }}
        {{- if .Values.env }}
        env:
          {{- toYaml .Values.env | nindent 10 }}
        {{- end }}
{{- end }}

