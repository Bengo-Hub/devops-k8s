{{- if .Values.cleanup }}
{{- if .Values.cleanup.enabled }}
{{- if eq .Values.cleanup.enabled true }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "app.fullname" . }}-cleanup-script
  labels:
    app: {{ include "app.fullname" . }}
    chart: {{ include "app.chart" . }}
data:
  cleanup.sh: |
    #!/bin/bash
    set -euo pipefail
    
    echo "ðŸ§¹ Running pre-deploy cleanup for {{ include "app.fullname" . }}..."
    
    # Namespace for this app
    NAMESPACE="{{ .Release.Namespace }}"
    APP_NAME="{{ include "app.fullname" . }}"
    
    # Delete failed/error pods for this app
    echo "ðŸ” Deleting failed pods in namespace $NAMESPACE for app $APP_NAME..."
    kubectl delete pods -n "$NAMESPACE" -l "app=$APP_NAME" \
      --field-selector="status.phase=Failed" \
      --grace-period=0 --force 2>/dev/null || true
    
    kubectl delete pods -n "$NAMESPACE" -l "app=$APP_NAME" \
      --field-selector="status.phase=Unknown" \
      --grace-period=0 --force 2>/dev/null || true
    
    # Delete ImagePullBackOff/ErrImagePull pods for this app
    echo "ðŸ” Deleting image pull error pods..."
    PULL_ERROR_PODS=$(kubectl get pods -n "$NAMESPACE" -l "app=$APP_NAME" \
      -o jsonpath='{.items[?(@.status.containerStatuses[*].state.waiting.reason=="ImagePullBackOff")].metadata.name}' 2>/dev/null || echo "")
    
    if [ -n "$PULL_ERROR_PODS" ]; then
      for POD in $PULL_ERROR_PODS; do
        echo "  ðŸ“¦ Deleting ImagePullBackOff pod: $POD"
        kubectl delete pod -n "$NAMESPACE" "$POD" --grace-period=0 --force 2>/dev/null || true
      done
    fi
    
    ERR_IMAGE_PODS=$(kubectl get pods -n "$NAMESPACE" -l "app=$APP_NAME" \
      -o jsonpath='{.items[?(@.status.containerStatuses[*].state.waiting.reason=="ErrImagePull")].metadata.name}' 2>/dev/null || echo "")
    
    if [ -n "$ERR_IMAGE_PODS" ]; then
      for POD in $ERR_IMAGE_PODS; do
        echo "  ðŸ“¦ Deleting ErrImagePull pod: $POD"
        kubectl delete pod -n "$NAMESPACE" "$POD" --grace-period=0 --force 2>/dev/null || true
      done
    fi
    
    # Delete old replicaset pods (keep only latest RS)
    echo "ðŸ” Cleaning up old replicaset pods..."
    OLD_RS=$(kubectl get rs -n "$NAMESPACE" -l "app=$APP_NAME" \
      --sort-by=.metadata.creationTimestamp \
      -o jsonpath='{.items[:-1].metadata.name}' 2>/dev/null || echo "")
    
    if [ -n "$OLD_RS" ]; then
      for RS in $OLD_RS; do
        PODS=$(kubectl get pods -n "$NAMESPACE" -l "app=$APP_NAME" \
          -o jsonpath="{.items[?(@.metadata.ownerReferences[0].name==\"$RS\")].metadata.name}" 2>/dev/null || echo "")
        
        if [ -n "$PODS" ]; then
          for POD in $PODS; do
            echo "  ðŸ“¦ Deleting old replicaset pod: $POD"
            kubectl delete pod -n "$NAMESPACE" "$POD" --grace-period=0 --force 2>/dev/null || true
          done
        fi
      done
    fi
    
    echo "âœ… Cleanup complete for {{ include "app.fullname" . }}"
    
    # Check current pod count
    TOTAL_PODS=$(kubectl get pods --all-namespaces --no-headers 2>/dev/null | wc -l)
    echo "  ðŸ“Š Total cluster pods: $TOTAL_PODS"
---
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "app.fullname" . }}-pre-deploy-cleanup-{{ .Release.Revision }}
  labels:
    app: {{ include "app.fullname" . }}
    chart: {{ include "app.chart" . }}
  annotations:
    # Run before helm install/upgrade
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-10"
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 300 # Delete job after 5 minutes
  backoffLimit: 2
  template:
    metadata:
      labels:
        app: {{ include "app.fullname" . }}-cleanup
    spec:
      serviceAccountName: {{ include "app.fullname" . }}-cleanup
      restartPolicy: OnFailure
      containers:
        - name: cleanup
          image: bitnami/kubectl:1.29
          imagePullPolicy: IfNotPresent
          command: ["/bin/bash", "/scripts/cleanup.sh"]
          volumeMounts:
            - name: cleanup-script
              mountPath: /scripts
      volumes:
        - name: cleanup-script
          configMap:
            name: {{ include "app.fullname" . }}-cleanup-script
            defaultMode: 0755
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: {{ include "app.fullname" . }}-cleanup
  labels:
    app: {{ include "app.fullname" . }}
    chart: {{ include "app.chart" . }}
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-15"
    helm.sh/hook-delete-policy: before-hook-creation
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "app.fullname" . }}-cleanup
  labels:
    app: {{ include "app.fullname" . }}
    chart: {{ include "app.chart" . }}
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-15"
    helm.sh/hook-delete-policy: before-hook-creation
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "delete"]
  - apiGroups: ["apps"]
    resources: ["replicasets"]
    verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "app.fullname" . }}-cleanup
  labels:
    app: {{ include "app.fullname" . }}
    chart: {{ include "app.chart" . }}
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-15"
    helm.sh/hook-delete-policy: before-hook-creation
subjects:
  - kind: ServiceAccount
    name: {{ include "app.fullname" . }}-cleanup
    namespace: {{ .Release.Namespace }}
roleRef:
  kind: Role
  name: {{ include "app.fullname" . }}-cleanup
  apiGroup: rbac.authorization.k8s.io
{{- end }}
{{- end }}
