{{- if and .Values.seed .Values.seed.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "app.fullname" . }}-seed-{{ .Values.image.tag | trunc 8 }}
  namespace: {{ .Release.Namespace }}
  labels:
    app: {{ include "app.fullname" . }}
    component: seed
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation
spec:
  ttlSecondsAfterFinished: 600
  backoffLimit: 2
  template:
    metadata:
      labels:
        app: {{ include "app.fullname" . }}
        component: seed
    spec:
      restartPolicy: Never
      {{- if .Values.image.pullSecrets }}
      imagePullSecrets:
        {{- toYaml .Values.image.pullSecrets | nindent 8 }}
      {{- end }}
      containers:
      - name: seed
        image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
        imagePullPolicy: {{ .Values.image.pullPolicy | default "IfNotPresent" }}
        command: ["/usr/local/bin/seed"]
        # Load environment variables from the same secret as the main app
        {{- if .Values.envFromSecret }}
        envFrom:
        - secretRef:
            name: {{ .Values.envFromSecret }}
        {{- end }}
        env:
        - name: SEED_ADMIN_PASSWORD
          value: {{ .Values.seed.adminPassword | default "ChangeMe123!" | quote }}
        resources:
          requests:
            memory: {{ .Values.seed.resources.requests.memory | default "256Mi" }}
            cpu: {{ .Values.seed.resources.requests.cpu | default "100m" }}
          limits:
            memory: {{ .Values.seed.resources.limits.memory | default "512Mi" }}
            cpu: {{ .Values.seed.resources.limits.cpu | default "500m" }}
{{- end }}

