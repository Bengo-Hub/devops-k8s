apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cm
  namespace: argocd
data:
  # Keep ignoreResourceUpdates and exclusions from the cluster defaults
  resource.customizations.ignoreResourceUpdates.ConfigMap: |
    jqPathExpressions:
      # Ignore the cluster-autoscaler status
      - '.metadata.annotations."cluster-autoscaler.kubernetes.io/last-updated"'
      # Ignore the annotation of the legacy Leases election
      - '.metadata.annotations."control-plane.alpha.kubernetes.io/leader"'
  resource.customizations.ignoreResourceUpdates.Endpoints: |
    jsonPointers:
      - /metadata
      - /subsets
  resource.customizations.ignoreResourceUpdates.all: |
    jsonPointers:
      - /status
  resource.customizations.ignoreResourceUpdates.apps_ReplicaSet: |
    jqPathExpressions:
      - '.metadata.annotations."deployment.kubernetes.io/desired-replicas"'
      - '.metadata.annotations."deployment.kubernetes.io/max-replicas"'
      - '.metadata.annotations."rollout.argoproj.io/desired-replicas"'
  resource.customizations.ignoreResourceUpdates.argoproj.io_Application: |
    jqPathExpressions:
      - '.metadata.annotations."notified.notifications.argoproj.io"'
      - '.metadata.annotations."argocd.argoproj.io/refresh"'
      - '.metadata.annotations."argocd.argoproj.io/hydrate"'
      - '.operation'
  resource.customizations.ignoreResourceUpdates.argoproj.io_Rollout: |
    jqPathExpressions:
      - '.metadata.annotations."notified.notifications.argoproj.io"'
  resource.customizations.ignoreResourceUpdates.autoscaling_HorizontalPodAutoscaler: |
    jqPathExpressions:
      - '.metadata.annotations."autoscaling.alpha.kubernetes.io/behavior"'
      - '.metadata.annotations."autoscaling.alpha.kubernetes.io/conditions"'
      - '.metadata.annotations."autoscaling.alpha.kubernetes.io/metrics"'
      - '.metadata.annotations."autoscaling.alpha.kubernetes.io/current-metrics"'
  resource.customizations.ignoreResourceUpdates.discovery.k8s.io_EndpointSlice: |
    jsonPointers:
      - /metadata
      - /endpoints
      - /ports
  resource.exclusions: |
    ### Network resources created by the Kubernetes control plane and excluded to reduce the number of watched events and
    UI clutter
    - apiGroups:
      - ''
      - discovery.k8s.io
      kinds:
      - Endpoints
      - EndpointSlice
    ### Internal Kubernetes resources excluded reduce the number of watched events
    - apiGroups:
      - coordination.k8s.io
      kinds:
      - Lease
    ### Internal Kubernetes Authz/Authn resources excluded reduce the number of watched events
    - apiGroups:
      - authentication.k8s.io
      - authorization.k8s.io
      kinds:
      - SelfSubjectReview
      - TokenReview
      - LocalSubjectAccessReview
      - SelfSubjectAccessReview
      - SelfSubjectRulesReview
      - SubjectAccessReview
    ### Intermediate Certificate Request excluded reduce the number of watched events
    - apiGroups:
      - certificates.k8s.io
      kinds:
      - CertificateSigningRequest
    - apiGroups:
      - cert-manager.io
      kinds:
      - CertificateRequest
    ### Cilium internal resources excluded reduce the number of watched events and UI Clutter
    - apiGroups:
      - cilium.io
      kinds:
      - CiliumIdentity
      - CiliumEndpoint
      - CiliumEndpointSlice
    ### Kyverno intermediate and reporting resources excluded reduce the number of watched events and improve performance
    - apiGroups:
      - kyverno.io
      - reports.kyverno.io
      - wgpolicyk8s.io
      kinds:
      - PolicyReport
      - ClusterPolicyReport
      - EphemeralReport
      - ClusterEphemeralReport
      - AdmissionReport
      - ClusterAdmissionReport
      - BackgroundScanReport
      - ClusterBackgroundScanReport
      - UpdateRequest
  # --- Health assessment customizations ---
  resource.customizations.health.apps_Deployment: |
    hs = {}
    if obj.status ~= nil then
      if obj.status.observedGeneration ~= nil and obj.metadata.generation ~= nil and
         obj.status.observedGeneration < obj.metadata.generation then
        hs.status = 'Progressing'
        hs.message = 'Waiting for rollout to finish: observed generation ' ..
          obj.status.observedGeneration .. ' < desired generation ' .. obj.metadata.generation
        return hs
      end
      if obj.status.replicas ~= nil and obj.status.updatedReplicas ~= nil and
         obj.status.replicas > obj.status.updatedReplicas then
        hs.status = 'Progressing'
        hs.message = 'Waiting for rollout to finish: ' .. obj.status.updatedReplicas ..
          ' out of ' .. obj.status.replicas .. ' new replicas have been updated'
        return hs
      end
      if obj.status.replicas ~= nil and obj.status.availableReplicas ~= nil and
         obj.status.replicas > obj.status.availableReplicas then
        hs.status = 'Progressing'
        hs.message = 'Waiting for rollout to finish: ' .. obj.status.availableReplicas ..
          ' out of ' .. obj.status.replicas .. ' new replicas are available'
        return hs
      end
      if obj.status.replicas ~= nil and obj.status.readyReplicas ~= nil and
         obj.status.replicas > obj.status.readyReplicas then
        hs.status = 'Progressing'
        hs.message = 'Waiting for rollout to finish: ' .. obj.status.readyReplicas ..
          ' out of ' .. obj.status.replicas .. ' new replicas are ready'
        return hs
      end
    end
    hs.status = 'Healthy'
    return hs
  resource.customizations.health.apps_StatefulSet: |
    hs = {}
    if obj.status ~= nil then
      if obj.status.observedGeneration ~= nil and obj.metadata.generation ~= nil and
         obj.status.observedGeneration < obj.metadata.generation then
        hs.status = 'Progressing'
        hs.message = 'Waiting for StatefulSet rollout: observed generation ' ..
          obj.status.observedGeneration .. ' < desired generation ' .. obj.metadata.generation
        return hs
      end
      if obj.status.replicas ~= nil and obj.status.readyReplicas ~= nil and
         obj.status.replicas > obj.status.readyReplicas then
        hs.status = 'Progressing'
        hs.message = 'Waiting for StatefulSet rollout: ' .. obj.status.readyReplicas ..
          ' out of ' .. obj.status.replicas .. ' replicas ready'
        return hs
      end
    end
    hs.status = 'Healthy'
    return hs
  resource.customizations.health.apps_DaemonSet: |
    hs = {}
    if obj.status ~= nil then
      if obj.status.observedGeneration ~= nil and obj.metadata.generation ~= nil and
         obj.status.observedGeneration < obj.metadata.generation then
        hs.status = 'Progressing'
        hs.message = 'Waiting for DaemonSet rollout: observed generation ' ..
          obj.status.observedGeneration .. ' < desired generation ' .. obj.metadata.generation
        return hs
      end
      if obj.status.desiredNumberScheduled ~= nil and obj.status.updatedNumberScheduled ~= nil and
         obj.status.desiredNumberScheduled > obj.status.updatedNumberScheduled then
        hs.status = 'Progressing'
        hs.message = 'Waiting for DaemonSet rollout: ' .. obj.status.updatedNumberScheduled ..
          ' out of ' .. obj.status.desiredNumberScheduled .. ' nodes updated'
        return hs
      end
      if obj.status.desiredNumberScheduled ~= nil and obj.status.numberReady ~= nil and
         obj.status.desiredNumberScheduled > obj.status.numberReady then
        hs.status = 'Progressing'
        hs.message = 'Waiting for DaemonSet rollout: ' .. obj.status.numberReady ..
          ' out of ' .. obj.status.desiredNumberScheduled .. ' nodes ready'
        return hs
      end
    end
    hs.status = 'Healthy'
    return hs
  resource.customizations.health.networking.k8s.io_Ingress: |
    hs = {}
    if obj.status ~= nil then
      if obj.status.loadBalancer ~= nil then
        if obj.status.loadBalancer.ingress ~= nil and #obj.status.loadBalancer.ingress > 0 then
          hs.status = 'Healthy'
          hs.message = 'LoadBalancer has IP assigned'
        else
          hs.status = 'Healthy'
          hs.message = 'Ingress resource created (awaiting LoadBalancer IP)'
        end
      else
        hs.status = 'Healthy'
        hs.message = 'Ingress endpoint ready'
      end
    else
      hs.status = 'Progressing'
      hs.message = 'Waiting for Ingress status'
    end
    return hs
  resource.customizations.health.core_Service: |
    hs = {}
    if obj.spec.type == 'LoadBalancer' then
      if obj.status ~= nil and obj.status.loadBalancer ~= nil and
         obj.status.loadBalancer.ingress ~= nil and #obj.status.loadBalancer.ingress > 0 then
        hs.status = 'Healthy'
      else
        hs.status = 'Progressing'
        hs.message = 'Waiting for LoadBalancer IP assignment'
      end
    else
      hs.status = 'Healthy'
    end
    return hs
  resource.customizations.health.core_PersistentVolumeClaim: |
    hs = {}
    if obj.status ~= nil and obj.status.phase ~= nil then
      if obj.status.phase == 'Pending' then
        hs.status = 'Progressing'
        hs.message = 'PVC is pending binding'
      elseif obj.status.phase == 'Bound' then
        hs.status = 'Healthy'
      else
        hs.status = 'Degraded'
      end
    else
      hs.status = 'Progressing'
    end
    return hs
  resource.customizations.health.core_ConfigMap: |
    hs = {}
    hs.status = 'Healthy'
    return hs
  resource.customizations.health.core_Secret: |
    hs = {}
    hs.status = 'Healthy'
    return hs
  resource.customizations.health.batch_Job: |
    hs = {}
    if obj.status ~= nil then
      if obj.status.succeeded ~= nil and obj.status.succeeded > 0 then
        hs.status = 'Healthy'
      elseif obj.status.failed ~= nil and obj.status.failed > 0 then
        hs.status = 'Degraded'
        hs.message = 'Job failed: ' .. obj.status.failed .. ' failures'
      else
        hs.status = 'Progressing'
        hs.message = 'Job running'
      end
    else
      hs.status = 'Progressing'
    end
    return hs
  resource.customizations.health.batch_CronJob: |
    hs = {}
    hs.status = 'Healthy'
    if obj.status ~= nil and obj.status.lastScheduleTime ~= nil then
      hs.message = 'CronJob scheduled'
    end
    return hs
  resource.customizations.health.autoscaling_HorizontalPodAutoscaler: |
    hs = {}
    hs.status = 'Healthy'
    return hs
  resource.customizations.health.autoscaling.k8s.io_VerticalPodAutoscaler: |
    hs = {}
    hs.status = 'Healthy'
    return hs
  resource.customizations.health.monitoring.coreos.com_ServiceMonitor: |
    hs = {}
    hs.status = 'Healthy'
    return hs
  resource.customizations.health.core_Secret: |
    hs = {}
    hs.status = 'Healthy'
    return hs
