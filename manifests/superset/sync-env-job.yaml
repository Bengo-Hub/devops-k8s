---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: superset-secret-sync
  namespace: infra
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: superset-secret-sync
  namespace: infra
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "create", "delete"]
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["get", "list", "patch"]
  - apiGroups: ["apps"]
    resources: ["deployments/status"]
    verbs: ["get"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: superset-secret-sync
  namespace: infra
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: superset-secret-sync
subjects:
  - kind: ServiceAccount
    name: superset-secret-sync
    namespace: infra
---
apiVersion: batch/v1
kind: Job
metadata:
  name: superset-env-sync
  namespace: infra
  labels:
    app: superset
    component: secret-sync
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: BeforeHookCreation
    argocd.argoproj.io/sync-wave: "0"  # Run after Helm deployment completes
spec:
  ttlSecondsAfterFinished: 300  # Auto-delete after 5 minutes
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: superset
        component: secret-sync
    spec:
      serviceAccountName: superset-secret-sync
      restartPolicy: OnFailure
      containers:
        - name: sync-secrets
          image: bitnami/kubectl:latest
          command:
            - /bin/bash
            - -c
            - |
              #!/bin/bash
              set -e

              echo "==================================="
              echo "Syncing Superset Secrets"
              echo "==================================="

              NAMESPACE="infra"
              SOURCE_SECRET="superset-secrets"
              TARGET_SECRET="superset-env"

              # Check if source secret exists
              if ! kubectl get secret "${SOURCE_SECRET}" -n "${NAMESPACE}" >/dev/null 2>&1; then
                  echo "ERROR: Source secret ${SOURCE_SECRET} not found in namespace ${NAMESPACE}"
                  echo "Run create-superset-secrets.sh from provision workflow first"
                  exit 1
              fi

              # Get values from superset-secrets
              echo "Reading credentials from ${SOURCE_SECRET}..."
              DB_PASS=$(kubectl get secret "${SOURCE_SECRET}" -n "${NAMESPACE}" -o jsonpath='{.data.DATABASE_PASSWORD}' | base64 -d)
              SECRET_KEY=$(kubectl get secret "${SOURCE_SECRET}" -n "${NAMESPACE}" -o jsonpath='{.data.SECRET_KEY}' | base64 -d)
              REDIS_PASS=$(kubectl get secret "${SOURCE_SECRET}" -n "${NAMESPACE}" -o jsonpath='{.data.REDIS_PASSWORD}' | base64 -d)

              if [ -z "${DB_PASS}" ] || [ -z "${SECRET_KEY}" ]; then
                  echo "ERROR: Failed to read required credentials from ${SOURCE_SECRET}"
                  exit 1
              fi

              # Wait for Helm to create superset-env secret
              echo "Waiting for Helm to create ${TARGET_SECRET}..."
              for i in $(seq 1 30); do
                  if kubectl get secret "${TARGET_SECRET}" -n "${NAMESPACE}" >/dev/null 2>&1; then
                      echo "✓ Secret ${TARGET_SECRET} found"
                      break
                  fi
                  echo "Waiting... ($i/30)"
                  sleep 2
              done

              # Patch superset-env with correct external service hostnames
              echo "Patching ${TARGET_SECRET} with correct external service hostnames..."
              kubectl patch secret "${TARGET_SECRET}" -n "${NAMESPACE}" --type='json' -p='[
                {"op": "replace", "path": "/data/DB_HOST", "value": "'$(echo -n "postgresql.infra.svc.cluster.local" | base64)'"},
                {"op": "replace", "path": "/data/DB_PORT", "value": "'$(echo -n "5432" | base64)'"},
                {"op": "replace", "path": "/data/DB_USER", "value": "'$(echo -n "superset_user" | base64)'"},
                {"op": "replace", "path": "/data/DB_PASS", "value": "'$(echo -n "${DB_PASS}" | base64)'"},
                {"op": "replace", "path": "/data/DB_NAME", "value": "'$(echo -n "superset" | base64)'"},
                {"op": "replace", "path": "/data/SECRET_KEY", "value": "'$(echo -n "${SECRET_KEY}" | base64)'"},
                {"op": "replace", "path": "/data/SUPERSET_SECRET_KEY", "value": "'$(echo -n "${SECRET_KEY}" | base64)'"},
                {"op": "replace", "path": "/data/REDIS_HOST", "value": "'$(echo -n "redis-master.infra.svc.cluster.local" | base64)'"},
                {"op": "replace", "path": "/data/REDIS_PORT", "value": "'$(echo -n "6379" | base64)'"},
                {"op": "replace", "path": "/data/REDIS_PASSWORD", "value": "'$(echo -n "${REDIS_PASS}" | base64)'"}
              ]'

              if [ $? -eq 0 ]; then
                  echo "✓ Secret ${TARGET_SECRET} patched successfully"
              else
                  echo "ERROR: Failed to patch ${TARGET_SECRET}"
                  exit 1
              fi

              # Restart deployments to pick up new secret
              echo "Restarting Superset deployments..."
              kubectl rollout restart deployment superset superset-worker superset-celerybeat -n "${NAMESPACE}" 2>/dev/null || true

              echo "✓ Deployments restarted"
              echo "✓ Superset environment secret synced from ${SOURCE_SECRET}"
              echo "==================================="
              echo "Sync completed successfully"
              echo "==================================="
