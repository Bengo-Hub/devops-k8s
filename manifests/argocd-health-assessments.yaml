---
# ArgoCD Health Assessment Customizations
# This patch adds health assessment rules for all missing-health applications
# including Deployments, StatefulSets, DaemonSets, and other common resources
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-cm-health-patch
  namespace: argocd
data:
  # Health assessment for Deployments (most apps use this)
  resource.customizations.health.apps_Deployment: |
    hs = {}
    if obj.status ~= nil then
      if obj.status.observedGeneration ~= nil and obj.metadata.generation ~= nil and
         obj.status.observedGeneration < obj.metadata.generation then
        hs.status = 'Progressing'
        hs.message = 'Waiting for rollout to finish: observed generation ' ..
          obj.status.observedGeneration .. ' < desired generation ' .. obj.metadata.generation
        return hs
      end
      if obj.status.replicas ~= nil and obj.status.updatedReplicas ~= nil and
         obj.status.replicas > obj.status.updatedReplicas then
        hs.status = 'Progressing'
        hs.message = 'Waiting for rollout to finish: ' .. obj.status.updatedReplicas ..
          ' out of ' .. obj.status.replicas .. ' new replicas have been updated'
        return hs
      end
      if obj.status.replicas ~= nil and obj.status.availableReplicas ~= nil and
         obj.status.replicas > obj.status.availableReplicas then
        hs.status = 'Progressing'
        hs.message = 'Waiting for rollout to finish: ' .. obj.status.availableReplicas ..
          ' out of ' .. obj.status.replicas .. ' new replicas are available'
        return hs
      end
      if obj.status.replicas ~= nil and obj.status.readyReplicas ~= nil and
         obj.status.replicas > obj.status.readyReplicas then
        hs.status = 'Progressing'
        hs.message = 'Waiting for rollout to finish: ' .. obj.status.readyReplicas ..
          ' out of ' .. obj.status.replicas .. ' new replicas are ready'
        return hs
      end
    end
    hs.status = 'Healthy'
    return hs
  
  # Health assessment for StatefulSets
  resource.customizations.health.apps_StatefulSet: |
    hs = {}
    if obj.status ~= nil then
      if obj.status.observedGeneration ~= nil and obj.metadata.generation ~= nil and
         obj.status.observedGeneration < obj.metadata.generation then
        hs.status = 'Progressing'
        hs.message = 'Waiting for StatefulSet rollout: observed generation ' ..
          obj.status.observedGeneration .. ' < desired generation ' .. obj.metadata.generation
        return hs
      end
      if obj.status.replicas ~= nil and obj.status.readyReplicas ~= nil and
         obj.status.replicas > obj.status.readyReplicas then
        hs.status = 'Progressing'
        hs.message = 'Waiting for StatefulSet rollout: ' .. obj.status.readyReplicas ..
          ' out of ' .. obj.status.replicas .. ' replicas ready'
        return hs
      end
    end
    hs.status = 'Healthy'
    return hs
  
  # Health assessment for DaemonSets
  resource.customizations.health.apps_DaemonSet: |
    hs = {}
    if obj.status ~= nil then
      if obj.status.observedGeneration ~= nil and obj.metadata.generation ~= nil and
         obj.status.observedGeneration < obj.metadata.generation then
        hs.status = 'Progressing'
        hs.message = 'Waiting for DaemonSet rollout: observed generation ' ..
          obj.status.observedGeneration .. ' < desired generation ' .. obj.metadata.generation
        return hs
      end
      if obj.status.desiredNumberScheduled ~= nil and obj.status.updatedNumberScheduled ~= nil and
         obj.status.desiredNumberScheduled > obj.status.updatedNumberScheduled then
        hs.status = 'Progressing'
        hs.message = 'Waiting for DaemonSet rollout: ' .. obj.status.updatedNumberScheduled ..
          ' out of ' .. obj.status.desiredNumberScheduled .. ' nodes updated'
        return hs
      end
      if obj.status.desiredNumberScheduled ~= nil and obj.status.numberReady ~= nil and
         obj.status.desiredNumberScheduled > obj.status.numberReady then
        hs.status = 'Progressing'
        hs.message = 'Waiting for DaemonSet rollout: ' .. obj.status.numberReady ..
          ' out of ' .. obj.status.desiredNumberScheduled .. ' nodes ready'
        return hs
      end
    end
    hs.status = 'Healthy'
    return hs
  
  # Health assessment for Ingress (with LoadBalancer support)
  resource.customizations.health.networking.k8s.io_Ingress: |
    hs = {}
    if obj.status ~= nil then
      if obj.status.loadBalancer ~= nil then
        if obj.status.loadBalancer.ingress ~= nil and #obj.status.loadBalancer.ingress > 0 then
          hs.status = 'Healthy'
          hs.message = 'LoadBalancer has IP assigned'
          return hs
        end
      end
    end
    hs.status = 'Healthy'
    hs.message = 'Ingress resource created (awaiting LoadBalancer IP)'
    return hs
  
  # Health assessment for Services (ClusterIP, NodePort, LoadBalancer)
  resource.customizations.health.core_Service: |
    hs = {}
    if obj.spec.type == 'LoadBalancer' then
      if obj.status ~= nil and obj.status.loadBalancer ~= nil and
         obj.status.loadBalancer.ingress ~= nil and #obj.status.loadBalancer.ingress > 0 then
        hs.status = 'Healthy'
      else
        hs.status = 'Progressing'
        hs.message = 'Waiting for LoadBalancer IP assignment'
      end
    else
      hs.status = 'Healthy'
    end
    return hs
  
  # Health assessment for Persistent Volume Claims
  resource.customizations.health.core_PersistentVolumeClaim: |
    hs = {}
    if obj.status ~= nil and obj.status.phase ~= nil then
      if obj.status.phase == 'Pending' then
        hs.status = 'Progressing'
        hs.message = 'PVC is pending binding'
      elseif obj.status.phase == 'Bound' then
        hs.status = 'Healthy'
      else
        hs.status = 'Degraded'
      end
    else
      hs.status = 'Progressing'
    end
    return hs
  
  # Mark ConfigMaps as Healthy (configuration resources)
  resource.customizations.health.core_ConfigMap: |
    hs = {}
    hs.status = 'Healthy'
    return hs
  
  # Mark Secrets as Healthy (configuration resources)
  resource.customizations.health.core_Secret: |
    hs = {}
    hs.status = 'Healthy'
    return hs
  
  # Health assessment for Jobs
  resource.customizations.health.batch_Job: |
    hs = {}
    if obj.status ~= nil then
      if obj.status.succeeded ~= nil and obj.status.succeeded > 0 then
        hs.status = 'Healthy'
      elseif obj.status.failed ~= nil and obj.status.failed > 0 then
        hs.status = 'Degraded'
        hs.message = 'Job failed: ' .. obj.status.failed .. ' failures'
      else
        hs.status = 'Progressing'
        hs.message = 'Job running'
      end
    else
      hs.status = 'Progressing'
    end
    return hs
  
  # Health assessment for CronJobs
  resource.customizations.health.batch_CronJob: |
    hs = {}
    hs.status = 'Healthy'
    if obj.status ~= nil and obj.status.lastScheduleTime ~= nil then
      hs.message = 'CronJob scheduled'
    end
    return hs
  
  # Health assessment for HPA
  resource.customizations.health.autoscaling_HorizontalPodAutoscaler: |
    hs = {}
    hs.status = 'Healthy'
    return hs
  
  # Health assessment for VPA
  resource.customizations.health.autoscaling.k8s.io_VerticalPodAutoscaler: |
    hs = {}
    hs.status = 'Healthy'
    return hs
  
  # Health assessment for ServiceMonitor (Prometheus operator)
  resource.customizations.health.monitoring.coreos.com_ServiceMonitor: |
    hs = {}
    hs.status = 'Healthy'
    return hs
