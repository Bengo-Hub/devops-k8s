apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: infra-db-queue-alerts
  namespace: infra
  labels:
    prometheus: kube-prometheus
spec:
  groups:
  - name: postgres.connections
    rules:
    - alert: PostgresConnectionsHigh
      expr: |
        (pg_stat_activity_count) / (pg_settings_max_connections) > 0.85
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "PostgreSQL connections at >85% of max"
        description: "High active connections may cause connection errors. Consider scaling connection poolers or read replicas."
  - name: redis.memory
    rules:
    - alert: RedisMemoryHigh
      expr: |
        redis_memory_used_bytes / redis_total_system_memory_bytes > 0.85
      for: 5m
      labels:
        severity: warning
      annotations:
        summary: "Redis memory usage above 85%"
        description: "Evictions/latency likely. Scale vertically or enable replication/sentinel."
  - name: rabbitmq.queues
    rules:
    - alert: RabbitMQQueueBacklog
      expr: |
        sum(rabbitmq_queue_messages_ready) > 1000
      for: 10m
      labels:
        severity: warning
      annotations:
        summary: "RabbitMQ backlog > 1000 messages"
        description: "Scale Celery workers via KEDA or investigate consumers."


